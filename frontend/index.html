<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Receptionist Demo (Option A) ‚Äî Dark Console</title>
  <style>
    :root{
      --bg0:#070b16;
      --bg1:#0b1530;
      --stroke:rgba(255,255,255,0.10);
      --stroke2:rgba(255,255,255,0.14);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.62);
      --muted2:rgba(255,255,255,0.45);
      --ok:#18d07b;
      --warn:#f4c84a;
      --bad:#ff6b6b;
      --blue:#4ea3ff;
      --shadow: 0 12px 30px rgba(0,0,0,0.35);
      --r18:18px;
      --r22:22px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(78,163,255,0.14), transparent 60%),
                  radial-gradient(900px 600px at 85% 20%, rgba(24,208,123,0.10), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .topbar{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:16px;
    }
    .titleBlock h2{margin:0; font-size:20px; font-weight:900; letter-spacing:0.2px;}
    .titleBlock .sub{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.4;}
    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius:999px;
      color: var(--muted);
      font-size:12px;
    }

    .console{
      display:grid;
      grid-template-columns: 1fr 1.5fr;
      gap:16px;
      align-items:start;
    }
    .col{display:flex; flex-direction:column; gap:16px;}

    .panel{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius: var(--r22);
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .panelHeader{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:14px;
    }
    .icon{
      width:40px; height:40px;
      border-radius: 12px;
      display:grid; place-items:center;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: var(--blue);
      flex: 0 0 auto;
    }
    .panelTitle{font-weight:900; font-size:14px; letter-spacing:0.2px;}
    .panelSub{color:var(--muted); font-size:12px; margin-top:2px;}

    .callCard{
      border:1px solid var(--stroke);
      border-radius: var(--r18);
      padding:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    }

    .agentBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      font-size:12px;
      color: var(--muted);
      margin-bottom:10px;
    }

    .wave{
      height:30px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background:
        linear-gradient(90deg,
          rgba(78,163,255,0.16) 0%,
          rgba(255,255,255,0.04) 30%,
          rgba(24,208,123,0.14) 60%,
          rgba(255,255,255,0.04) 100%);
      background-size: 220% 100%;
      opacity:0.8;
    }
    .wave.active{ animation: wave 1.2s linear infinite; opacity:1; }
    @keyframes wave{ 0%{background-position:0% 0} 100%{background-position:220% 0} }

    .rowBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}

    button{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      cursor:pointer;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      font-weight:700;
    }
    button:hover{ background: rgba(255,255,255,0.08); border-color: var(--stroke2); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:0.55; cursor:not-allowed; }

    .primary{
      border-color: rgba(78,163,255,0.35);
      background: rgba(78,163,255,0.14);
    }
    .primary:hover{ background: rgba(78,163,255,0.18); }

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px;}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:110px; resize: vertical;}
    select{cursor:pointer;}
    .hint{margin-top:10px; font-size:12px; color:var(--muted2); line-height:1.4;}

    /* Chat */
    .chat{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.12);
      border-radius: var(--r18);
      padding:12px;
      height: 380px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      max-width: 86%;
      border-radius: 16px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
    }
    .bubble.agent{ align-self:flex-start; }
    .bubble.user{
      align-self:flex-end;
      background: rgba(78,163,255,0.12);
      border-color: rgba(78,163,255,0.28);
    }
    .meta{font-size:11px; font-weight:900; color: var(--muted); margin-bottom:4px; letter-spacing:0.2px;}
    .text{white-space: pre-wrap; font-size:13px; color: var(--text);}

    .section{margin-top:12px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      font-size:12px;
      font-weight:900;
      letter-spacing:0.2px;
    }
    .pill.green{ border-color: rgba(24,208,123,0.35); background: rgba(24,208,123,0.12); color: rgba(214,255,238,0.95); }
    .pill.yellow{ border-color: rgba(244,200,74,0.40); background: rgba(244,200,74,0.12); color: rgba(255,245,214,0.95); }
    .pill.red{ border-color: rgba(255,107,107,0.45); background: rgba(255,107,107,0.14); color: rgba(255,229,229,0.95); }

    .summaryBlock{
      margin-top:12px;
      border:1px solid var(--stroke);
      border-radius: var(--r18);
      padding:12px;
      background: rgba(0,0,0,0.12);
    }
    .summaryBlock textarea{min-height:150px;}

    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(24,208,123,0.35);
      background: rgba(24,208,123,0.10);
      color: rgba(220,255,238,0.95);
      font-weight:900;
    }
    .hidden{display:none;}

    /* Calendar */
    .calendar{
      border:1px solid var(--stroke);
      border-radius: var(--r18);
      padding:12px;
      background: rgba(0,0,0,0.12);
    }
    .calTop{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .calLabel{font-weight:900; letter-spacing:0.2px; color:var(--text);}
    .calDow, .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .calDow div{
      text-align:center;
      font-size:11px;
      color: var(--muted2);
      letter-spacing:0.2px;
    }
    .day{
      height:44px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      color: var(--text);
      transition: background .12s ease, border-color .12s ease;
    }
    .day:hover{ background: rgba(255,255,255,0.07); border-color: var(--stroke2); }
    .day.muted{ opacity:0.35; cursor:default; }
    .day.muted:hover{ background: rgba(255,255,255,0.04); border-color: var(--stroke); }
    .day.hasSlot{
      border-color: rgba(24,208,123,0.30);
      background: rgba(24,208,123,0.08);
    }
    .day.selected{
      outline: 2px solid rgba(78,163,255,0.50);
    }

    .slots{margin-top:12px;}
    .slotList{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
    .slot{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      cursor:pointer;
      font-size:12px;
      font-weight:800;
      color: var(--text);
    }
    .slot:hover{ background: rgba(255,255,255,0.08); border-color: var(--stroke2); }
    .slot.booked{
      border-color: rgba(24,208,123,0.35);
      background: rgba(24,208,123,0.12);
      color: rgba(214,255,238,0.95);
    }

    .footnote{
      margin-top:14px;
      color: var(--muted2);
      font-size:12px;
      line-height:1.4;
      border-top:1px solid var(--stroke);
      padding-top:12px;
    }

    @media (max-width: 980px){
      .console{grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="titleBlock">
      <h2>Voice Receptionist (Option A) ‚Äî Demo Console</h2>
      <div class="sub">
        Push-to-talk voice intake with rules-based flow + urgency flag + calendar-referenced slot offering.
        <br/>No audio is stored. This demo does not provide medical advice.
      </div>
    </div>
    <div class="chips">
      <div class="chip">üéô Browser STT</div>
      <div class="chip">üó£ Browser TTS</div>
      <div class="chip">üóìÔ∏è Calendar demo</div>
      <div class="chip">üõ°Ô∏è Rule-based</div>
    </div>
  </div>

  <div class="console">

    <!-- LEFT COLUMN -->
    <div class="col">
      <div class="panel">
        <div class="panelHeader">
          <div class="icon">üìû</div>
          <div>
            <div class="panelTitle">Incoming Call / AI Call</div>
            <div class="panelSub" id="callStatus">Idle</div>
          </div>
        </div>

        <div class="callCard">
          <div class="agentBadge">ü§ñ AI Agent active</div>
          <div class="wave" id="wave"></div>

          <div class="rowBtns">
            <button id="btnStart" class="primary">üéô Start Listening</button>
            <button id="btnStop" disabled>‚èπ Stop</button>
            <button id="btnReset">üîÑ Reset</button>
          </div>

          <div class="grid2">
            <div>
              <label>Language</label>
              <select id="lang">
                <option value="de-DE" selected>German (de-DE)</option>
                <option value="en-US">English (en-US)</option>
              </select>
            </div>
            <div>
              <label>Voice Output</label>
              <select id="voiceSelect"></select>
            </div>
          </div>

          <div class="hint">
            Tip: Speak, then press Stop. The agent will parse your message and ask the next question.
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHeader">
          <div class="icon">üóìÔ∏è</div>
          <div>
            <div class="panelTitle">Appointment Calendar</div>
            <div class="panelSub">Demo availability (no real booking)</div>
          </div>
        </div>

        <div class="calendar">
          <div class="calTop">
            <button id="prevMonth">‚Äπ</button>
            <div id="calLabel" class="calLabel">‚Äî</div>
            <button id="nextMonth">‚Ä∫</button>
          </div>

          <div class="calDow">
            <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
          </div>

          <div id="calGrid" class="calGrid" style="margin-top:8px;"></div>

          <div class="slots">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <div style="color:var(--muted); font-size:12px;">Available slots</div>
              <div style="color:var(--muted2); font-size:12px;" id="selDayLabel">Select a day</div>
            </div>
            <div id="slotList" class="slotList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="col">
      <div class="panel">
        <div class="panelHeader">
          <div class="icon">üí¨</div>
          <div>
            <div class="panelTitle">Live Transcript</div>
            <div class="panelSub">Agent / Patient messages</div>
          </div>
        </div>

        <div id="chat" class="chat"></div>

        <div class="section">
          <label>Live transcript while speaking</label>
          <textarea id="liveTranscript" placeholder="You'll see live text here..." readonly></textarea>
        </div>

        <div class="summaryBlock">
          <div style="display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
              <span style="color:var(--muted); font-size:12px;">Urgency:</span>
              <span id="urgencyPill" class="pill green">GREEN</span>
            </div>
            <div style="color:var(--muted2); font-size:12px;">Doctor handover</div>
          </div>

          <textarea id="summaryBox" readonly placeholder="Summary will appear here..."></textarea>

          <div class="rowBtns" style="margin-top:10px;">
            <button id="btnFinalize" class="primary">‚úÖ Finalize Summary</button>
            <button id="btnCopy">üìã Copy Summary</button>
          </div>

          <div id="bookingBanner" class="banner hidden">‚úÖ Appointment successfully booked (demo).</div>
        </div>

        <div class="footnote">
          <b>Safety boundary:</b> The assistant collects information only and does not provide diagnosis or medication instructions.
        </div>
      </div>
    </div>
  </div>

<script>
/** ===========================
 *  STATE
 *  =========================== */
const state = {
  step: "GREETING",
  intent: null, // "pain" | "implant" | "checkup"
  proposed_slot: null, // {dateKey, time}
  collected: {
    name: null,
    phone: null,
    reason: null,
    pain_scale: null,
    pain_duration: null,
    swelling: null,
    fever: null,
    meds: null,
    implant_when: null,
    implant_loose: null,
    bleeding: null,
    preferred_time: null
  },
  transcript_history: []
};

/** ===========================
 *  UI REFS
 *  =========================== */
const chatEl = document.getElementById("chat");
const liveEl = document.getElementById("liveTranscript");
const summaryEl = document.getElementById("summaryBox");
const urgencyPillEl = document.getElementById("urgencyPill");
const langEl = document.getElementById("lang");
const voiceSelectEl = document.getElementById("voiceSelect");
const callStatusEl = document.getElementById("callStatus");
const waveEl = document.getElementById("wave");
const bookingBannerEl = document.getElementById("bookingBanner");

const calGridEl = document.getElementById("calGrid");
const calLabelEl = document.getElementById("calLabel");
const slotListEl = document.getElementById("slotList");
const selDayLabelEl = document.getElementById("selDayLabel");

/** ===========================
 *  CHAT RENDER
 *  =========================== */
function escapeHtml(str) {
  return (str ?? "").replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function addMsg(who, txt) {
  const b = document.createElement("div");
  const cls = (who === "USER") ? "user" : "agent";
  const label = (who === "USER") ? (langEl.value.startsWith("de") ? "Patient" : "Patient")
              : (who === "SYSTEM") ? "System"
              : (langEl.value.startsWith("de") ? "AI-Agent" : "AI Agent");

  b.className = `bubble ${cls}`;
  b.innerHTML = `<div class="meta">${label}</div><div class="text">${escapeHtml(txt)}</div>`;
  chatEl.appendChild(b);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/** ===========================
 *  TTS (queue-safe)
 *  IMPORTANT: do NOT cancel each speak, otherwise greeting gets cut off.
 *  =========================== */
let voices = [];
function loadVoices() {
  voices = window.speechSynthesis.getVoices() || [];
  voiceSelectEl.innerHTML = "";
  voices.forEach((v, idx) => {
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSelectEl.appendChild(opt);
  });

  const targetLang = langEl.value;
  const matchIdx = voices.findIndex(v => (v.lang || "").toLowerCase() === targetLang.toLowerCase());
  if (matchIdx >= 0) voiceSelectEl.value = String(matchIdx);
}
window.speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function speak(text, { interrupt = false } = {}) {
  if (!text) return;
  if (interrupt) window.speechSynthesis.cancel();

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = langEl.value;

  const idx = parseInt(voiceSelectEl.value || "0", 10);
  if (voices[idx]) utter.voice = voices[idx];

  window.speechSynthesis.speak(utter);
}
function assistantSay(text) {
  addMsg("ASSISTANT", text);
  speak(text, { interrupt: false });
}
function assistantAsk(q) {
  addMsg("ASSISTANT", q);
  speak(q, { interrupt: false });
}

/** ===========================
 *  TEXT DICTIONARY
 *  =========================== */
function getText(key) {
  const de = {
    opening: "Hallo! Ich bin die digitale Rezeption. Ich stelle ein paar kurze Fragen und leite die Infos an die Zahnarztpraxis weiter. Hinweis: Ich kann keine medizinische Beratung geben. Ist das okay?",
    ask_reason: "Was ist der Grund f√ºr Ihren Besuch? Zum Beispiel: starke Schmerzen, Implantat-Problem, Kontrolle oder Reinigung.",
    ask_name: "Wie ist Ihr Name?",
    ask_phone: "Wie ist Ihre Telefonnummer?",
    pain_scale: "Wie stark sind die Schmerzen auf einer Skala von 0 bis 10?",
    pain_duration: "Seit wann haben Sie die Schmerzen? Zum Beispiel: seit 2 Tagen oder seit einer Woche.",
    swelling: "Haben Sie Schwellung im Gesicht oder am Zahnfleisch? Ja oder nein.",
    fever: "Haben Sie Fieber? Ja oder nein.",
    meds: "Haben Sie Schmerzmittel oder Antibiotika genommen? Wenn ja, welche?",
    implant_when: "Wann wurde das Implantat gesetzt? Ungef√§hres Datum oder wie viele Monate oder Jahre her.",
    implant_loose: "F√ºhlt sich das Implantat oder die Krone locker an? Ja oder nein.",
    bleeding: "Gibt es Blutung oder Eiter? Ja oder nein.",
    preferred_time: "Haben Sie eine bevorzugte Zeit oder einen bevorzugten Tag f√ºr den Termin?",
    confirm_done: "Danke. Das war‚Äôs. Ich habe alle Infos aufgenommen."
  };

  const en = {
    opening: "Hello! I‚Äôm the digital receptionist. I‚Äôll ask a few quick questions and pass the information to the clinic. Note: I can‚Äôt provide medical advice. Is that okay?",
    ask_reason: "What‚Äôs the reason for your visit? For example: severe pain, implant issue, checkup, or cleaning.",
    ask_name: "What is your name?",
    ask_phone: "What is your phone number?",
    pain_scale: "How strong is the pain on a scale from 0 to 10?",
    pain_duration: "How long have you had the pain? For example: 2 days or 1 week.",
    swelling: "Do you have swelling in the face or gums? Yes or no.",
    fever: "Do you have fever? Yes or no.",
    meds: "Have you taken painkillers or antibiotics? If yes, which ones?",
    implant_when: "When was the implant placed? Approximate date or how many months/years ago.",
    implant_loose: "Does the implant or crown feel loose? Yes or no.",
    bleeding: "Is there bleeding or pus? Yes or no.",
    preferred_time: "Do you have a preferred day or time for the appointment?",
    confirm_done: "Thanks. That‚Äôs all. I‚Äôve captured the information."
  };

  const dict = (langEl.value.startsWith("de")) ? de : en;
  return dict[key] || key;
}

/** ===========================
 *  STT (Web Speech API)
 *  =========================== */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;
let listening = false;
let finalTextBuffer = "";

function setupRecognition() {
  if (!SpeechRecognition) {
    addMsg("SYSTEM", "SpeechRecognition not supported in this browser. Use Chrome/Edge.");
    return;
  }
  rec = new SpeechRecognition();
  rec.lang = langEl.value;
  rec.interimResults = true;
  rec.continuous = false;

  rec.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      const text = res[0].transcript;
      if (res.isFinal) finalTextBuffer += text + " ";
      else interim += text;
    }
    liveEl.value = (finalTextBuffer + interim).trim();
  };

  rec.onend = () => {
    listening = false;
    document.getElementById("btnStart").disabled = false;
    document.getElementById("btnStop").disabled = true;

    callStatusEl.textContent = "Idle";
    waveEl.classList.remove("active");

    const finalText = (finalTextBuffer || "").trim();
    finalTextBuffer = "";
    liveEl.value = "";

    if (finalText) handleUserUtterance(finalText);
  };

  rec.onerror = (e) => {
    listening = false;
    addMsg("SYSTEM", `STT error: ${e.error || "unknown"}`);
    document.getElementById("btnStart").disabled = false;
    document.getElementById("btnStop").disabled = true;

    callStatusEl.textContent = "Idle";
    waveEl.classList.remove("active");
  };
}

langEl.addEventListener("change", () => {
  if (rec) { try { rec.abort(); } catch {} }
  setupRecognition();
  loadVoices();
  // Re-render calendar labels (language)
  renderCalendar();
  if (selectedDay) renderSlotsForDay(selectedDay);
});

/** ===========================
 *  BUTTONS
 *  =========================== */
document.getElementById("btnStart").onclick = () => {
  if (!rec) setupRecognition();
  if (!rec) return;

  rec.lang = langEl.value;
  finalTextBuffer = "";
  listening = true;

  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnStop").disabled = false;

  callStatusEl.textContent = "Listening‚Ä¶";
  waveEl.classList.add("active");

  rec.start();
};

document.getElementById("btnStop").onclick = () => {
  if (!rec) return;
  try { rec.stop(); } catch {}
};

document.getElementById("btnReset").onclick = () => resetSession();

document.getElementById("btnFinalize").onclick = () => {
  const s = buildSummary();
  summaryEl.value = s.text;
  setUrgencyPill(s.urgency);

  addMsg("ASSISTANT",
    langEl.value.startsWith("de")
      ? "Hier ist die strukturierte Zusammenfassung f√ºr die Praxis."
      : "Here is the structured handover summary for the clinic."
  );

  speak(langEl.value.startsWith("de")
    ? "Danke. Ich habe die Informationen zusammengefasst. Bitte schauen Sie die Zusammenfassung auf dem Bildschirm an."
    : "Thank you. I have summarized the information. Please review the summary on the screen.",
    { interrupt: true }
  );
};

document.getElementById("btnCopy").onclick = async () => {
  try {
    await navigator.clipboard.writeText(summaryEl.value || "");
    addMsg("SYSTEM", langEl.value.startsWith("de") ? "Zusammenfassung kopiert." : "Summary copied.");
  } catch {
    addMsg("SYSTEM", langEl.value.startsWith("de") ? "Kopieren nicht m√∂glich (Browser-Rechte)." : "Copy failed (browser permission).");
  }
};

/** ===========================
 *  INTAKE PARSING
 *  =========================== */
function detectIntent(text) {
  const t = text.toLowerCase();
  if (/(implant|krone locker|locker|abutment|schraube)/i.test(t)) return "implant";
  if (/(schmerz|pain|toothache|weh|notfall|emergency)/i.test(t)) return "pain";
  if (/(kontrolle|checkup|reinigung|cleaning|prophylaxe)/i.test(t)) return "checkup";
  return null;
}

function parseYesNo(text) {
  const t = text.toLowerCase().trim();
  if (/(ja|yes|yep|genau|stimmt|ok|okay|bitte|mach|book|buchen)/.test(t)) return true;
  if (/(nein|no|nope|nicht|lieber nicht|dont|don't)/.test(t)) return false;
  return null;
}

function extractPhone(text) {
  const cleaned = text.replace(/[^\d+ ]/g, " ");
  const m = cleaned.match(/(\+?\d[\d ]{7,}\d)/);
  return m ? m[1].replace(/\s+/g, " ").trim() : null;
}

function extractName(text) {
  const m1 = text.match(/(?:ich bin|mein name ist)\s+([A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\- ]{2,})/i);
  const m2 = text.match(/(?:my name is|i am)\s+([A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\- ]{2,})/i);
  const raw = (m1 && m1[1]) || (m2 && m2[1]) || null;
  if (!raw) return null;
  return raw.trim().split(" ").slice(0, 4).join(" ");
}

function extractPainScale(text) {
  const m = text.match(/\b(10|[0-9])\b/);
  if (!m) return null;
  const n = parseInt(m[1], 10);
  if (Number.isFinite(n) && n >= 0 && n <= 10) return n;
  return null;
}

/** ===========================
 *  CALENDAR + BOOKING (DEMO)
 *  =========================== */
let viewDate = new Date();
let selectedDay = null;

// Demo availability map: YYYY-MM-DD -> slots
const availability = new Map();
// Track booked slots: "YYYY-MM-DD|HH:MM"
const booked = new Set();

function toKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function isBooked(dateKey, timeStr){
  return booked.has(`${dateKey}|${timeStr}`);
}
function markBooked(dateKey, timeStr){
  booked.add(`${dateKey}|${timeStr}`);
}

// seed some demo slots
function seedAvailability(){
  availability.clear();
  const base = new Date();
  for (let i=2; i<=24; i+=3){
    const d = new Date(base.getFullYear(), base.getMonth(), base.getDate() + i);
    availability.set(toKey(d), ["09:30","10:15","11:00"]);
  }
}
seedAvailability();

function renderCalendar(){
  calGridEl.innerHTML = "";
  slotListEl.innerHTML = "";
  selDayLabelEl.textContent = langEl.value.startsWith("de") ? "Tag ausw√§hlen" : "Select a day";

  const y = viewDate.getFullYear();
  const m = viewDate.getMonth();
  calLabelEl.textContent = viewDate.toLocaleString(undefined, { month:"long", year:"numeric" });

  const first = new Date(y, m, 1);
  const startDay = (first.getDay() + 6) % 7; // Mon=0
  const daysInMonth = new Date(y, m+1, 0).getDate();

  for (let i=0; i<42; i++){
    const cell = document.createElement("div");
    cell.className = "day";
    const dayNum = i - startDay + 1;

    if (dayNum < 1 || dayNum > daysInMonth){
      cell.classList.add("muted");
      cell.textContent = "";
      calGridEl.appendChild(cell);
      continue;
    }

    const d = new Date(y, m, dayNum);
    const key = toKey(d);
    cell.textContent = String(dayNum);

    if (availability.has(key)) cell.classList.add("hasSlot");
    if (selectedDay && toKey(selectedDay) === key) cell.classList.add("selected");

    cell.onclick = () => {
      selectedDay = d;
      renderCalendar();
      renderSlotsForDay(d);
    };

    calGridEl.appendChild(cell);
  }
}

function renderSlotsForDay(d){
  slotListEl.innerHTML = "";
  const key = toKey(d);
  selDayLabelEl.textContent = d.toLocaleDateString(undefined, { weekday:"short", day:"2-digit", month:"short" });

  const slots = availability.get(key) || [];
  if (!slots.length){
    const info = document.createElement("div");
    info.style.color = "var(--muted)";
    info.style.fontSize = "12px";
    info.textContent = langEl.value.startsWith("de") ? "Keine Slots (Demo)." : "No slots (demo).";
    slotListEl.appendChild(info);
    return;
  }

  slots.forEach((t) => {
    const s = document.createElement("div");
    s.className = "slot";
    s.textContent = t;

    if (isBooked(key, t)) {
      s.classList.add("booked");
      s.style.opacity = "0.7";
    }

    s.onclick = () => {
      if (isBooked(key, t)) return;
      // manual demo-booking via UI
      markBooked(key, t);
      s.classList.add("booked");
      bookingBannerEl.classList.remove("hidden");

      addMsg("ASSISTANT",
        langEl.value.startsWith("de")
          ? `Gebucht (Demo): ${formatOffer(key, t)}. Best√§tigung wurde gesendet.`
          : `Booked (demo): ${formatOffer(key, t)}. Confirmation has been sent.`
      );

      speak(langEl.value.startsWith("de")
        ? `Gebucht. ${d.toLocaleDateString("de-DE")} um ${t}.`
        : `Booked. ${d.toLocaleDateString("en-US")} at ${t}.`,
        { interrupt: true }
      );
    };

    slotListEl.appendChild(s);
  });
}

document.getElementById("prevMonth").onclick = () => {
  viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1);
  renderCalendar();
  if (selectedDay) renderSlotsForDay(selectedDay);
};
document.getElementById("nextMonth").onclick = () => {
  viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1);
  renderCalendar();
  if (selectedDay) renderSlotsForDay(selectedDay);
};

function formatOffer(dateKey, timeStr) {
  const d = new Date(dateKey + "T00:00:00");
  if (langEl.value.startsWith("de")) {
    return `${d.toLocaleDateString("de-DE", { weekday:"long", day:"2-digit", month:"2-digit" })} um ${timeStr}`;
  }
  return `${d.toLocaleDateString("en-US", { weekday:"long", month:"short", day:"2-digit" })} at ${timeStr}`;
}

function findBestSlot(preferredText = "") {
  const pref = (preferredText || "").toLowerCase();

  // weekday hints
  const weekdayHints = [
    { keys: ["montag","monday","mo"], day: 1 },
    { keys: ["dienstag","tuesday","di"], day: 2 },
    { keys: ["mittwoch","wednesday","mi"], day: 3 },
    { keys: ["donnerstag","thursday","do"], day: 4 },
    { keys: ["freitag","friday","fr"], day: 5 },
    { keys: ["samstag","saturday","sa"], day: 6 },
    { keys: ["sonntag","sunday","so"], day: 0 },
  ];

  let preferredDow = null;
  for (const w of weekdayHints) {
    if (w.keys.some(k => pref.includes(k))) { preferredDow = w.day; break; }
  }

  const wantsMorning = /(morning|vormittag|morgens)/.test(pref);
  const wantsAfternoon = /(afternoon|nachmittag)/.test(pref);

  const keys = Array.from(availability.keys()).sort(); // YYYY-MM-DD sorts OK

  let best = null;

  // Try satisfy weekday + time
  for (const dateKey of keys) {
    const slots = availability.get(dateKey) || [];
    const d = new Date(dateKey + "T00:00:00");
    if (preferredDow !== null && d.getDay() !== preferredDow) continue;

    for (const t of slots) {
      if (isBooked(dateKey, t)) continue;

      const hour = parseInt(t.split(":")[0], 10);
      if (wantsMorning && hour >= 12) continue;
      if (wantsAfternoon && hour < 12) continue;

      best = { dateKey, time: t };
      break;
    }
    if (best) break;
  }

  // fallback earliest
  if (!best) {
    for (const dateKey of keys) {
      const slots = availability.get(dateKey) || [];
      for (const t of slots) {
        if (!isBooked(dateKey, t)) return { dateKey, time: t };
      }
    }
  }

  return best; // may be null
}

/** ===========================
 *  STATE MACHINE
 *  =========================== */
function resetSession() {
  state.step = "GREETING";
  state.intent = null;
  state.proposed_slot = null;
  state.transcript_history = [];
  for (const k of Object.keys(state.collected)) state.collected[k] = null;

  chatEl.innerHTML = "";
  summaryEl.value = "";
  setUrgencyPill("green");
  bookingBannerEl.classList.add("hidden");

  // Speak opening then reason question; do not cancel between them
  setTimeout(() => {
    // Clear any prior speech once
    speak("", { interrupt: true });
    assistantSay(getText("opening"));
    assistantAsk(getText("ask_reason"));
    state.step = "ASK_REASON";
  }, 80);
}

function handleUserUtterance(text) {
  state.transcript_history.push(text);
  addMsg("USER", text);

  // opportunistic fill
  if (!state.collected.phone) {
    const ph = extractPhone(text);
    if (ph) state.collected.phone = ph;
  }
  if (!state.collected.name) {
    const nm = extractName(text);
    if (nm) state.collected.name = nm;
  }

  switch (state.step) {
    case "ASK_REASON": {
      const intent = detectIntent(text);
      state.intent = intent || "pain";
      state.collected.reason = text.trim();
      state.step = "ASK_NAME";
      break;
    }
    case "ASK_NAME": {
      if (!state.collected.name) state.collected.name = text.trim();
      state.step = "ASK_PHONE";
      break;
    }
    case "ASK_PHONE": {
      if (!state.collected.phone) state.collected.phone = text.trim();
      state.step = "INTENT_FLOW";
      break;
    }

    // pain flow
    case "PAIN_SCALE": {
      const n = extractPainScale(text);
      if (n !== null) state.collected.pain_scale = n;
      state.step = "PAIN_DURATION";
      break;
    }
    case "PAIN_DURATION": {
      state.collected.pain_duration = text.trim();
      state.step = "SWELLING";
      break;
    }
    case "SWELLING": {
      const yn = parseYesNo(text);
      state.collected.swelling = (yn === null) ? text.trim() : (yn ? "yes" : "no");
      state.step = "FEVER";
      break;
    }
    case "FEVER": {
      const yn = parseYesNo(text);
      state.collected.fever = (yn === null) ? text.trim() : (yn ? "yes" : "no");
      state.step = "MEDS";
      break;
    }
    case "MEDS": {
      state.collected.meds = text.trim();
      state.step = "PREFERRED_TIME";
      break;
    }

    // implant flow
    case "IMPLANT_WHEN": {
      state.collected.implant_when = text.trim();
      state.step = "IMPLANT_LOOSE";
      break;
    }
    case "IMPLANT_LOOSE": {
      const yn = parseYesNo(text);
      state.collected.implant_loose = (yn === null) ? text.trim() : (yn ? "yes" : "no");
      state.step = "BLEEDING";
      break;
    }
    case "BLEEDING": {
      const yn = parseYesNo(text);
      state.collected.bleeding = (yn === null) ? text.trim() : (yn ? "yes" : "no");
      state.step = "PREFERRED_TIME";
      break;
    }

    // checkup
    case "CHECKUP_DONE": {
      state.step = "PREFERRED_TIME";
      break;
    }

    // ask appointment preferences -> propose slot from calendar
    case "PREFERRED_TIME": {
      state.collected.preferred_time = text.trim();

      const best = findBestSlot(state.collected.preferred_time);
      if (!best) {
        state.step = "DONE";
        assistantSay(langEl.value.startsWith("de")
          ? "Leider habe ich gerade keine verf√ºgbaren Zeiten im Demo-Kalender."
          : "Unfortunately, there are no available slots in the demo calendar right now."
        );
        break;
      }

      state.proposed_slot = best;

      // visually select proposed day and render slots
      selectedDay = new Date(best.dateKey + "T00:00:00");
      viewDate = new Date(selectedDay.getFullYear(), selectedDay.getMonth(), 1);
      renderCalendar();
      renderSlotsForDay(selectedDay);

      state.step = "BOOK_CONFIRM";
      break;
    }

    // confirm booking yes/no
    case "BOOK_CONFIRM": {
      const yn = parseYesNo(text);

      if (yn === true && state.proposed_slot) {
        const { dateKey, time } = state.proposed_slot;
        markBooked(dateKey, time);

        selectedDay = new Date(dateKey + "T00:00:00");
        viewDate = new Date(selectedDay.getFullYear(), selectedDay.getMonth(), 1);
        renderCalendar();
        renderSlotsForDay(selectedDay);

        bookingBannerEl.classList.remove("hidden");

        assistantSay(langEl.value.startsWith("de")
          ? `Gebucht (Demo): ${formatOffer(dateKey, time)}. Best√§tigung wurde gesendet.`
          : `Booked (demo): ${formatOffer(dateKey, time)}. Confirmation has been sent.`
        );

        state.step = "DONE";
      } else if (yn === false) {
        const next = findBestSlot(""); // earliest
        if (next) {
          state.proposed_slot = next;

          selectedDay = new Date(next.dateKey + "T00:00:00");
          viewDate = new Date(selectedDay.getFullYear(), selectedDay.getMonth(), 1);
          renderCalendar();
          renderSlotsForDay(selectedDay);

          assistantAsk(langEl.value.startsWith("de")
            ? `Okay. Dann kann ich ${formatOffer(next.dateKey, next.time)} anbieten. Soll ich buchen?`
            : `Okay. Then I can offer ${formatOffer(next.dateKey, next.time)}. Should I book it?`
          );
          // stay in BOOK_CONFIRM
        } else {
          assistantSay(langEl.value.startsWith("de")
            ? "Okay. Dann bitte rufen Sie die Praxis an, um einen Termin zu finden."
            : "Okay. Please call the clinic to arrange a time."
          );
          state.step = "DONE";
        }
      } else {
        assistantAsk(langEl.value.startsWith("de")
          ? "Soll ich den Termin buchen? Bitte sagen Sie Ja oder Nein."
          : "Should I book the appointment? Please say yes or no."
        );
      }
      break;
    }

    default:
      break;
  }

  const q = nextQuestion();
  if (q) assistantAsk(q);
  else {
    // if done, close + show summary
    if (state.step === "DONE") {
      assistantSay(getText("confirm_done"));
      const s = buildSummary();
      summaryEl.value = s.text;
      setUrgencyPill(s.urgency);
      state.step = "DONE_FINAL";
    }
  }
}

function nextQuestion() {
  if (state.step === "ASK_NAME") return getText("ask_name");
  if (state.step === "ASK_PHONE") return getText("ask_phone");

  if (state.step === "INTENT_FLOW") {
    if (state.intent === "implant") { state.step = "IMPLANT_WHEN"; return getText("implant_when"); }
    if (state.intent === "checkup") { state.step = "CHECKUP_DONE"; return langEl.value.startsWith("de") ? "Geht es um Kontrolle oder Reinigung?" : "Is this for a checkup or cleaning?"; }
    state.step = "PAIN_SCALE";
    return getText("pain_scale");
  }

  // pain questions
  if (state.step === "PAIN_SCALE") return getText("pain_scale");
  if (state.step === "PAIN_DURATION") return getText("pain_duration");
  if (state.step === "SWELLING") return getText("swelling");
  if (state.step === "FEVER") return getText("fever");
  if (state.step === "MEDS") return getText("meds");

  // implant questions
  if (state.step === "IMPLANT_WHEN") return getText("implant_when");
  if (state.step === "IMPLANT_LOOSE") return getText("implant_loose");
  if (state.step === "BLEEDING") return getText("bleeding");

  // appointment preference
  if (state.step === "PREFERRED_TIME") return getText("preferred_time");

  // offer based on calendar
  if (state.step === "BOOK_CONFIRM" && state.proposed_slot) {
    const { dateKey, time } = state.proposed_slot;
    return langEl.value.startsWith("de")
      ? `Ich sehe im Kalender ${formatOffer(dateKey, time)} frei. Soll ich buchen?`
      : `I see ${formatOffer(dateKey, time)} available in the calendar. Should I book it?`;
  }

  return null;
}

/** ===========================
 *  URGENCY + SUMMARY
 *  =========================== */
function computeUrgency() {
  let level = "green";

  const pain = state.collected.pain_scale;
  const swelling = (state.collected.swelling || "").toString().toLowerCase();
  const fever = (state.collected.fever || "").toString().toLowerCase();
  const bleeding = (state.collected.bleeding || "").toString().toLowerCase();
  const loose = (state.collected.implant_loose || "").toString().toLowerCase();

  const swellingYes = swelling.includes("yes") || swelling.includes("ja");
  const feverYes = fever.includes("yes") || fever.includes("ja");
  const bleedingYes = bleeding.includes("yes") || bleeding.includes("ja");
  const looseYes = loose.includes("yes") || loose.includes("ja");

  if ((swellingYes && feverYes) || (pain !== null && pain >= 8) || bleedingYes) return "red";
  if (swellingYes || (pain !== null && pain >= 5) || looseYes) level = "yellow";

  return level;
}
function setUrgencyPill(level) {
  urgencyPillEl.classList.remove("green","yellow","red");
  urgencyPillEl.classList.add(level);
  urgencyPillEl.textContent = level.toUpperCase();
}

function buildSummary() {
  const urgency = computeUrgency();
  const c = state.collected;

  const lines = [];
  lines.push(`Patient: ${c.name || "‚Äî"} | Phone: ${c.phone || "‚Äî"}`);
  lines.push(`Reason (raw): ${c.reason || "‚Äî"}`);
  lines.push(`Intent: ${state.intent || "‚Äî"}`);
  lines.push(`Urgency: ${urgency.toUpperCase()}`);

  if (state.intent === "pain" || (!state.intent && c.pain_scale !== null)) {
    lines.push("");
    lines.push("Pain intake:");
    lines.push(`- Pain scale: ${c.pain_scale ?? "‚Äî"}/10`);
    lines.push(`- Duration: ${c.pain_duration || "‚Äî"}`);
    lines.push(`- Swelling: ${c.swelling || "‚Äî"}`);
    lines.push(`- Fever: ${c.fever || "‚Äî"}`);
    lines.push(`- Meds taken: ${c.meds || "‚Äî"}`);
  }

  if (state.intent === "implant") {
    lines.push("");
    lines.push("Implant intake:");
    lines.push(`- Implant placed: ${c.implant_when || "‚Äî"}`);
    lines.push(`- Loose: ${c.implant_loose || "‚Äî"}`);
    lines.push(`- Bleeding/pus: ${c.bleeding || "‚Äî"}`);
  }

  if (state.intent === "checkup") {
    lines.push("");
    lines.push("Checkup / Cleaning:");
    lines.push("- Patient requests routine appointment.");
  }

  lines.push("");
  lines.push(`Preferred time: ${c.preferred_time || "‚Äî"}`);

  if (state.proposed_slot) {
    lines.push(`Proposed slot (calendar): ${formatOffer(state.proposed_slot.dateKey, state.proposed_slot.time)}`);
  }

  lines.push("Safety note: This is not medical advice. Please triage clinically.");

  return { urgency, text: lines.join("\n") };
}

/** ===========================
 *  INIT
 *  =========================== */
renderCalendar();
resetSession();
</script>

</body>
</html>
